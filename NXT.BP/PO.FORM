SUBROUTINE PO.FORM(PO_ID,OP_REC,FD,OPTS,GUIERRORS,GUISTATE)
**************************************************************************
* This is free and unencumbered software released into the public domain.
*
* Anyone is free to copy, modify, publish, use, compile, sell, or
* distribute this software, either in source code form or as a compiled
* binary, for any purpose, commercial or non-commercial, and by any
* means.
*
* In jurisdictions that recognize copyright laws, the author or authors
* of this software dedicate any and all copyright interest in the
* software to the public domain. We make this dedication for the benefit
* of the public at large and to the detriment of our heirs and
* successors. We intend this dedication to be an overt act of
* relinquishment in perpetuity of all present and future rights to this
* software under copyright law.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
* IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR
* OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
* ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
* OTHER DEALINGS IN THE SOFTWARE.
*
* For more information, please refer to <https://unlicense.org>
**************************************************************************
*
* MODULE: INVOICE.FORM
* AUTHOR: MAB
* VERSION: 1.0.0
* CREATED: 00/00/2014
* UPDATED:
*
* MAINTENANCE RECORD:
*
* EQUATE:
*
*
* VARIABLES:
*  ON ENTRY:
*    OP_ID - PO_PARENT RECORD ID TO PRINT
*    OPTS  <1> - 0 TO PRINT ALL PO ITEMS OR ITEM NUMBER TO PRINT
*
* FILES:
*
*
* DESIGN DESCRIPTION:
* CREATE PCL INVOICE
** INCLUDE STANDARD VARIABLE, EQUATES
*
$INCLUDE NXT.INCLUDES NXT.COMMON
$INCLUDE NXT.INCLUDES NXT.EQUATES
$INCLUDE NXT.INCLUDES NXT.PRT.EQUATES
$INCLUDE NXT.INCLUDES NXT.ERR.MSGS
$INCLUDE NXT.INCLUDES PO_PARENT.H
$INCLUDE NXT.INCLUDES PO_CHILD.H
$INCLUDE NXT.INCLUDES WO.H
$INCLUDE NXT.INCLUDES VENDORS.H

!

*
!
MSG_LIST = ''
*
* GET THE TEMPLATE
*
CALL PO.TEMPLATE(FD)
*
VN_ID = OP_REC<PO_VEN>   ;* VENDOR ID
CALL GET.RECORD("VENDORS",C.VENDORS,VN_ID,VN_REC,@FALSE,ERROR_STATUS,MSG_LIST,GUIERRORS,GUISTATE)
IF VN_REC # '' THEN
  *
  * INIT SOME STUFF
  *
  PAGE.CNT = 1

  YMAX = 2800  ;* MAX DOT POSITION FOR BOTTOM OF PACK SLIP
  *
  * GET AR RECORD
  * POPULATE CUSTOMER DATA
  *

  *
  * SET UP THE  VENDOR  INFO
  *
  *
  BILL.NAME = VN_REC<VN_NAME>
  BILL.ADD1 = VN_REC<VN_ADDR>
  BILL.ADD2 = VN_REC<VN_ADDR2>
  BILL.CSZ = VN_REC<VN_CITY>:', ':VN_REC<VN_STATE>:' ':VN_REC<VN_ZIP>
  BILL.COUNTRY  = VN_REC<VN_COUNTRY>
  *
  *
  * NOW SQUEEZE THEM DOWN
  *
  BILL.ADDRESS = ''
  AA = 1
  *
  IF BILL.ADD1 # '' THEN
    BILL.ADDRESS<AA> = BILL.ADD1
    AA +=1
  END
  *
  IF BILL.ADD2 # '' THEN
    BILL.ADDRESS<AA> = BILL.ADD2
    AA +=1
  END
  *
  IF BILL.CSZ # '' THEN
    BILL.ADDRESS<AA> = BILL.CSZ
    AA +=1
  END
  *
  IF BILL.COUNTRY # '' THEN
    BILL.ADDRESS<AA> = BILL.COUNTRY
    AA +=1
  END
  *
PRT.HDR: *
  **
  * PRINT HEADER
  **
  FD = FD:CG12:ESC:'*p1815x100Y':PO_ID
  *
  FD = FD:ESC:'*p1815x150Y':OCONV(OP_REC<PO_DATE>,PO_DATE.CNV)
  FD = FD:ESC:'*p1815x200Y':OCONV(DATE(),PO_DATE.CNV)
  *
  FD = FD:CPI.10
  FD = FD:ESC:'*p80x495Y':BILL.NAME "L#26"
  FD = FD:ESC:'*p80x545Y':BILL.ADDRESS<1> "L#26"
  FD = FD:ESC:'*p80x595Y':BILL.ADDRESS<2> "L#26"
  FD = FD:ESC:'*p80x645Y':BILL.ADDRESS<3> "L#26"
  FD = FD:ESC:'*p80x695Y':BILL.ADDRESS<4> "L#26"
  FD = FD:ESC:'*p80x745Y':BILL.ADDRESS<5> "L#26"
  *

  *
  *

  FD = FD:CPI.10:ESC:'*p770x940Y':OP_REC<PO_BUYER>  'L#25':OP_REC<PO_VEN>'L#10':OP_REC<PO_SHIP_VIA>'L#20'
  *
  * NOW SAVE THIS AS A PAGE TEMPLATE
  *
  TEMPLATE = FD

  *
  *  GET THE CHILD RECORDS
  *
  CHILD.CNT = DCOUNT(OP_REC<PO_CHILD>,@VM)
  YPOS = 1075
  YINC = 50
  IF OPTS<1> = 0 THEN   ;* PRINT ALL
    FOR SI = 1 TO CHILD.CNT
      GOSUB PRINT.CHILD
    NEXT SI
  END ELSE
    SI = OPTS<1>
  END
  *
  IF YPOS # 1075  THEN   ;* WE ARE USING THE Y POSITION VALUE YPOS TO SEE IF WE JUST PRINTED A NEW PAGE, IF SO SKIP THIS
    IF PAGE.CNT LE 1 THEN  ;* HAVE WE ALREADY PRINTED THE PURCHASE AGENT SIGNOFF ?
      FD = FD:CG12:ESC:'*p300x2900Y':'Purchasing Agent:'
      FD = FD:ESC:'*p300x2900Y':ESC:'*c1095a3b0P'        ;* lw line
    END
    FD = FD:CG12:ESC:'*p1500x2900Y':'** Please Confirm **'
    FD = FD:CG12:ESC:'*p20x2900Y':'Page: ' : PAGE.CNT
  END
  *
END ELSE
  PRMPT = "Vendor: ":VN_ID:" is not available, Status Code: ":ERROR_STATUS
  CAPTION = "Purchase Order Print"
  STYLE   = 2  ;* !
  BUTTONS = 0  ;* ok
  HELPID = ""
  CALL NXT.ERR.MSG(PRMPT, CAPTION, STYLE, BUTTONS, HELPID, RESPONSE, GUIERRORS,GUISTATE)
END
*
RETURN
!
* PRINT.CHILD
* SI - INDEX TO CHILD ID IN PO_PARENT<PO_CHILD> FIELD
!
PRINT.CHILD:
OC_ID = PO_ID:'*':OP_REC<PO_CHILD,SI>
CALL GET.RECORD("PO_CHILD",C.PO_CHILD,OC_ID,OC_REC,@FALSE,ERROR_STATUS,MSG_LIST,GUIERRORS,GUISTATE)
IF OC_REC # '' THEN
  *

  *
  * PRINT SALES RECORD DATA ON INVOICE

  REV.LEVEL = OC_REC<PC_REV>
  *
  QTY = OC_REC<PC_ORD_QTY>

  *
  YPOS += YINC
  FD = FD:ESC:'*p40x':YPOS:'Y':QTY
  FD = FD:ESC:'*p220x':YPOS:'Y':SI
  *
  IF OC_REC<PC_PART_NBR> # '' THEN
    PN.REV = OC_REC<PC_PART_NBR>

    IF REV.LEVEL # '' THEN
      PN.REV = PN.REV:' rev: ':REV.LEVEL
    END
    FD = FD:ESC:'*p340x':YPOS:'Y':PN.REV
  END ELSE
    IF OC_REC<PC_WO_NBR> # '' THEN
      CALL GET.RECORD("WO",C.WO,OC_REC<PC_WO_NBR>,WO_REC,@FALSE,ERROR.STATUS,MSG_LIST,GUIERRORS,GUISTATE)
      IF WO_REC # '' THEN
        REV.LEVEL =  WO_REC<WO_PN_REV>
        PN.REV = WO_REC<WO_PARTNBR>

        IF REV.LEVEL # '' THEN
          PN.REV = PN.REV:' rev: ':REV.LEVEL
        END
        FD = FD:ESC:'*p340x':YPOS:'Y':PN.REV
      END ELSE
        LOG.OPTS  = "DISPLAY"
        ERROR_NBR = ERR_SYS
        ERROR_MSG =  "PO: ":PO_ID:" References Wo: ":OC_REC<PC_WO_NBR>:', Not On File!'
        CALL LOG.ERROR(LOG.OPTS,PROG_ID, ERROR_NBR, ERROR_MSG, GUIERRORS, GUISTATE)
      END
    END
  END
  *
  * PRICE AND EXTENSION
  *
  FD = FD:ESC:'*p1800x':YPOS:'Y':OCONV(OC_REC<PC_PRICE_EA>,PC_PRICE_EA.CNV)"R#8"

  *
  FD = FD:ESC:'*p2090x':YPOS:'Y':OCONV(OC_REC<PC_DUE_DATE>,PC_DUE_DATE.CNV)"R#10"
  *
  *
  IF OC_REC<PC_PART_DESC> # '' THEN
    YPOS += YINC
    FD = FD:ESC:'*p340x':YPOS:'Y':OC_REC<PC_PART_DESC>
    IF OC_REC<PC_LOT_FLAG> THEN
      FD = FD:ESC:'*p1800x':YPOS:'Y':"Lot Chrg"
    END
    GOSUB PAGETEST
  END
  *
  * ADD IN WO / SEQ
  *
  IF OC_REC<PC_WO_NBR> # '' THEN
    YPOS += YINC
    FD = FD:ESC:'*p340x':YPOS:'Y':'Ref. Work Order: ':OC_REC<PC_WO_NBR>:' ':OC_REC<PC_WO_SEQ>
    GOSUB PAGETEST
  END
  *
  *
  *  ADD IN THE PO DESCRIPTION
  *
  IF OC_REC<PC_DESC_TEXT> # '' THEN
    LNCNT = DCOUNT(OC_REC<PC_DESC_TEXT>,@VM)
    YPOS += YINC
    FOR LI = 1 TO LNCNT

      *          FD = FD:ESC:'*p340x':YPOS:'Y':OC_REC<PC_DESC_TEXT,LI>
      DATA.LN = OC_REC<PC_DESC_TEXT,LI>
      GOSUB LN.PRINT

    NEXT LI
  END
  *

  *
END ELSE
  PRMPT = "PO CHILD (ITEM): ":OC_ID:" is not available, Status Code: ":ERROR_STATUS
  CAPTION = "Purchase Order Print"
  STYLE   = 2  ;* !
  BUTTONS = 0  ;* ok
  HELPID = ""
  CALL NXT.ERR.MSG(PRMPT, CAPTION, STYLE, BUTTONS, HELPID, RESPONSE, GUIERRORS,GUISTATE)
END

GOSUB PAGETEST
RETURN
!
* LN.PRINT
* MUST BREAK UP TEXT LINE TO FIT ON FORM (60 CHARACTERS MAX)
* SHOULD REALLY MAKE THIS BREAK AT SPACE CHARACTER, MAYBE IN RELEASE 1.0
!
LN.PRINT: *
LN.LEN = LEN(DATA.LN)
GOSUB PAGETEST
IF LN.LEN > 75 THEN
  LN = DATA.LN[1,75]
  DATA.LN = DATA.LN[76,LN.LEN]
  FD = FD:CPI.16:ESC:'*p340x':YPOS:'Y':LN"L#75"
  YPOS += YINC
  IF LEN(TRIM(DATA.LN)) > 0 THEN GOTO LN.PRINT
END ELSE
  FD = FD:CPI.16:ESC:'*p340x':YPOS:'Y':DATA.LN"L#75"
  YPOS += YINC
END
FD = FD:CPI.10
RETURN
!
* PAGE TEST
!
PAGETEST: *
IF YPOS > 2800 THEN
  FD = FD:CG12:ESC:'*p300x2900Y':'Purchasing Agent:'
  FD = FD:ESC:'*p300x2900Y':ESC:'*c1095a3b0P'        ;* lw line
  FD = FD:CG12:ESC:'*p1500x2900Y':'** Please Confirm **'
  FD = FD:CG12:ESC:'*p20x2900Y':'Page: ' : PAGE.CNT : FF  ;* ADD A FORM FEED
  *FD = FD:ESC:'*p0x2815Y':ESC:'*c2395a60b5g2P'    ;* shade this box

  FD = FD : TEMPLATE ;* ADD IN A BLANK TEMPLATE
  *
  * RESET THE Y FORM POSITION
  YPOS = 1075
  PAGE.CNT += 1
END
RETURN

END
